<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="chrome">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/css/commonStyle.css">
	<link rel="stylesheet" href="/css/readLogsStyle.css">

	<!-- Datepicker 사용을 위한 jQuery, jQuery-UI 라이브러리 추가 -->
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/i18n/datepicker-ko.min.js"></script>
	<!-- 한국어 지역 설정 추가 -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/i18n/jquery-ui-timepicker-ko.js"></script>
	<!-- Timepicker 한국어 지역 설정 추가 -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">

	<!-- Datepicker 적용 스크립트 -->
	<script>
		$.datepicker.setDefaults({
			showButtonPanel: true,
			controlType: 'select',
			closeText: "적용",
			currentText: "오늘",
			prevText: '이전 달',
			nextText: '다음 달',
			monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
			monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
			dayNames: ['일', '월', '화', '수', '목', '금', '토'],
			dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
			dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
			weekHeader: "주",
			yearSuffix: '년'
		});

		$(function () {
			$("#startDate").datepicker({
				dateFormat: "yy-mm-dd",
				onSelect: function (selectedDate) {
					$("#endDate").datepicker("option", "minDate", selectedDate);
				},
				onClose: function (selectedDate) {
					if (new Date(selectedDate) > new Date($("#endDate").val())) {
						alert("시작 날짜는 종료 날짜보다 이후일 수 없습니다.");
						$("#startDate").datepicker("setDate", $("#endDate").val());
					}
				}
			});

			$("#endDate").datepicker({
				dateFormat: "yy-mm-dd",
				onSelect: function (selectedDate) {
					$("#startDate").datepicker("option", "maxDate", selectedDate);
				},
				onClose: function (selectedDate) {
					if (new Date(selectedDate) < new Date($("#startDate").val())) {
						alert("종료 날짜는 시작 날짜보다 이전일 수 없습니다.");
						$("#endDate").datepicker("setDate", $("#startDate").val());
					}
				}
			});

			$.timepicker.setDefaults($.timepicker.regional['ko']);

			$("#startTime, #endTime").timepicker({
				timeFormat: 'HH:mm:ss',
				controlType: 'select',
				closeText: "적용",
				currentText: "현재 시각",
				oneLine: true,
				timeInput: true,
				showButtonPanel: true,
				stepHour: 1,
				stepMinute: 1,
				stepSecond: 1,
			});

			$("#startTime").change(function () {
				if ($("#startDate").val() == $("#endDate").val() && $("#startTime").val() > $("#endTime").val()) {
					alert("시작 시간은 종료 시간보다 이후일 수 없습니다");
					$("#startTime").val($("#endTime").val());
				}
			});

			$("#endTime").change(function () {
				if ($("#startDate").val() == $("#endDate").val() && $("#endTime").val() < $("#startTime").val()) {
					alert("종료 시간은 시작 시간보다 이전일 수 없습니다");
					$("#endTime").val($("#startTime").val());
				}
			});
		});

		function isValidIp(ip) {
			var pattern = new RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/);
			return pattern.test(ip) || ip === "" || ip === "0" || ip.toLowerCase() === "any";
		}

		function validateForm() {
			var ip = document.getElementById("ip").value;

			if (!isValidIp(ip)) {
				alert("입력된 IP가 유효한 IP 주소 형식이 아닙니다.");
				return false;
			} else {
				return true;
			}
		}
		/*	
				$(function() {
					$('form').on('submit', function(e) {
						e.preventDefault();
						$.ajax({
							url: '/admin/menu/readLogs/api/getLogList',
							method: 'GET',
							data: $(this).serialize(),
							success: function(data) {
								$('#logList').empty();
								data.forEach(function(log) {
									var li = $('<li>');
									li.append($('<span>').text(log.log_index + ' '));
									li.append($('<span>').text(log.log_date + ' '));
									var detectedNameLink = $('<a>').attr('href', '/admin/menu/readLogs/viewLogs/' + log.log_date + '/' + log.log_index).text(log.detected_name);
									li.append(detectedNameLink);
									li.append($('<span>').text(' ' + log.level + ' '));
									li.append($('<span>').text(log.action + ' '));
									li.append($('<span>').text(log.src_ip + ' '));
									$('#logList').append(li);
								});
							}
						});
					});
				}); */
		/*********************************************************************/
		$(function () {
			$('form').on('submit', function (e) {
				e.preventDefault();
				$.ajax({
					url: '/admin/menu/readLogs/api/getLogList',
					method: 'GET',
					data: $(this).serialize(),
					success: function (data) {
						$('#logTable').empty();
						data.forEach(function (log) {
							var row = $('<tr>');
							row.append($('<td>').text(log.log_index));
							row.append($('<td>').text(log.log_date));
							row.append($('<td>').text(log.detected_name));
							row.append($('<td>').text(log.level));
							row.append($('<td>').text(log.src_ip));
							row.append($('<td>').text(log.action));
							var buttonCell = $('<td>');
							var button1 = $('<button>').text('패킷').addClass('pkBt').on('click', function () {
								window.location.href = '/admin/menu/readLogs/viewLogs/' + log.log_date + '/' + log.log_index;                 
							});
							var button2 = $('<button>').text('상세보기').addClass('infoBt').on('click', function () {
								/* window.location.href = // 상세보기 맵핑 도메인 추가 */
							});
							buttonCell.append(button1).append(button2);
							row.append(buttonCell);
							$('#logTable').append(row);
						});
					}
				});
			});
			$('form').on('submit', function (e) {
				e.preventDefault();
				getLogList();
			});

			$('.applyB').on('click', function () {
				getLogList();
			});
		});


		/*********************************************************************/
		function resetFilters() {
			var today = new Date().toISOString().slice(0, 10);
			$("#ip").val('any');
			$("#level").val('-1');
			$("#action").val('-1');
			$("#startDate").val(today);
			$("#startTime").val('00:00:00');
			$("#endDate").val(today);
			$("#endTime").val('23:59:59');
			return false;
		}
	</script>

	<title>Sentinel</title>
</head>

<body>
	<header>
		<div class="hline">
			<h1>로그조회</h1>
		</div>
	</header>
	<div class="log-list-filter">
		<form th:action="@{/admin/menu/readLogs}" method="get" onsubmit="return validateForm()">
			<h2>필터</h2>
			<div class="lft">
				<div class="input-group">
					<label for="ip">IP:</label>
					<input type="text" id="ip" name="ip" th:attr="value=${ip!=null}?${ip}:'any'">
				</div>

				<div class="input-group">
					<label for="level">위험등급:</label>
					<select id="level" name="level" class="custom-input-group">
						<option value="-1" th:selected="${level == -1}">전체</option>
						<option value="0" th:selected="${level == 0}">하</option>
						<option value="1" th:selected="${level == 1}">중</option>
						<option value="2" th:selected="${level == 2}">상</option>
						<option value="3" th:selected="${level == 3}">최상</option>
					</select>
				</div>

				<div class="input-group">
					<label for="action">동작:</label>
					<select id="action" name="action" class="custom-input-group">
						<option value="-1" th:selected="${action == -1}">전체</option>
						<option value="0" th:selected="${action == 0}">탐지</option>
						<option value="1" th:selected="${action == 1}">탐지+경고</option>
						<option value="2" th:selected="${action == 2}">탐지+차단</option>
						<option value="3" th:selected="${action == 3}">탐지+차단+경고</option>
					</select>
				</div>
			</div>
			<div class="rft">
				<div class="input-group datepicker">
					<label for="startDate">시작 지점 날짜:</label>
					<input type="text" id="startDate" name="startDate" class="datepicker"
						th:attr="value=${startDate!=null}?${startDate}:${today}">
					<input type="text" id="startTime" name="startTime" class="timepicker"
						th:attr="value=${startTime!=null}?${startTime}:'00:00:00'">
				</div>

				<div class="input-group datepicker">
					<label for="endDate">종료 지점 날짜:</label>
					<input type="text" id="endDate" name="endDate" class="datepicker"
						th:attr="value=${endDate!=null}?${endDate}:${today}">
					<input type="text" id="endTime" name="endTime" class="timepicker"
						th:attr="value=${endTime!=null}?${endTime}:'23:59:59'">
				</div>

				<div class="button-group">
					<button class="button2 applyB" type="submit">적용</button>
					<button class="button2 resetB" type="button" onclick="resetFilters()">초기화</button>
				</div>
			</div>
		</form>
	</div>
	<div class="logListBox">
		<table>
			<thead>
				<tr>
					<th>No</th>
					<th>시간</th>
					<th>내용</th>
					<th>위험등급</th>
					<th>IP</th>
					<th>동작</th>
					<th> </th>
				</tr>
			</thead>
			<tbody id="logTable">
				<!-- 여기에 로그가 동적으로 추가됩니다 -->
			</tbody>
		</table>
	</div>
</body>

</html>